let database,admin;_8db‍.x([["default",()=>_8db‍.o]]);_8db‍.w("firebase-functions",[["database",["database"],function(v){database=v}]]);_8db‍.w("firebase-admin",[["default",["admin"],function(v){admin=v}]]);


_8db‍.d(database
  .ref('/user_chat_messages/{senderUid}/{receiverUid}/{messageUid}')
  .onUpdate((data, context) => {
    if (context.authType === 'ADMIN') {
      return null
    }

    const senderUid = context.params.senderUid
    const receiverUid = context.params.receiverUid
    const messageUid = context.params.messageUid
    const senderChatRef = admin
      .database()
      .ref(`/user_chats/${senderUid}/${receiverUid}`)
    const receiverChatRef = admin
      .database()
      .ref(`/user_chats/${receiverUid}/${senderUid}`)
    const receiverChatMessageRef = admin
      .database()
      .ref(`/user_chat_messages/${receiverUid}/${senderUid}/${messageUid}`)
    const setSenderMessageRead = () =>
      senderChatRef.update({ isRead: context.timestamp })
    const setReceiverChatRead = () =>
      receiverChatRef.update({ isRead: context.timestamp })
    _8db‍.g.console.log(`Marking value`, data.after.child('isRead').val())

    if (data.after.child('isRead').val() === true) {
      console.log(`Marking message ${messageUid} as read`)
      return receiverChatMessageRef
        .update({
          isRead: context.timestamp,
        })
        .then(setSenderMessageRead)
        .then(setReceiverChatRead)
    } else {
      return null
    }
  }));
