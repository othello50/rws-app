let functions,admin,setClaim,removeClaim;_8db‍.x([["default",()=>_8db‍.o]]);_8db‍.w("firebase-functions",[["*",null,function(v){functions=v}]]);_8db‍.w("firebase-admin",[["default",["admin"],function(v){admin=v}]]);_8db‍.w("../../utils/customClaims",[["setClaim",["setClaim"],function(v){setClaim=v}],["removeClaim",["removeClaim"],function(v){removeClaim=v}]]);



const wait = t => {
  return new Promise((reseolve, reject) => {
    setTimeout(() => reseolve(), t)
  })
}

const random = (min, max) => {
  return Math.random() * (max - min) + min
}

_8db‍.d(functions
  .region('europe-west1')
  .database.ref('user_grants/{uid}/{grant}')
  .onWrite(async (snap, context) => {
    const value = snap.after.val()
    const { uid, grant } = context.params

    await admin
      .firestore()
      .doc(`/user_grants/${uid}/`)
      .set(
        { [grant]: value ? value : admin.firestore.FieldValue.delete() },
        { merge: true }
      )

    console.log('Waiting....')
    await wait(random(1000, 4000))

    if (snap.after.exists() && value.indexOf('storage') !== -1) {
      await customClaims.setClaim(uid, grant)
    } else {
      await customClaims.removeClaim(uid, grant)
    }

    const user = await admin.auth().getUser(uid)

    _8db‍.g.console.log('customClaims', Object.keys(user.customClaims).length)
    _8db‍.g.console.log('customClaims', user.customClaims)

    return
  }));
