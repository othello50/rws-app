let database,admin;_8db‍.x([["default",()=>_8db‍.o]]);_8db‍.w("firebase-functions",[["database",["database"],function(v){database=v}]]);_8db‍.w("firebase-admin",[["default",["admin"],function(v){admin=v}]]);


_8db‍.d(database
  .ref('/role_grants/{roleUid}/{grantUid}')
  .onWrite((eventSnapshot, context) => {
    const roleUid = context.params.roleUid
    const grantUid = context.params.grantUid

    const userRolesRef = admin.database().ref(`user_roles`)

    return userRolesRef.once('value').then(snapshot => {
      let promises = []

      snapshot.forEach(userRoles => {
        const userUid = userRoles.key
        const roles = userRoles.val()

        Object.keys(roles).forEach((key, index) => {
          if (key === roleUid) {
            let grantRef = false

            _8db‍.g.console.log('User role changed:', eventSnapshot.val())

            if (eventSnapshot.val()) {
              grantRef = admin
                .database()
                .ref(`user_grants/${userUid}/${grantUid}`)
                .set(true)
            } else {
              grantRef = admin
                .database()
                .ref(`user_grants/${userUid}/${grantUid}`)
                .remove()
            }

            promises.push(grantRef)

            _8db‍.g.console.log('Role changed', userUid, roleUid, grantUid)
          }
        })
      })

      return Promise.all(promises)
    })
  }));
